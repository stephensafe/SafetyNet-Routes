<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SafetyNet Room</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body style="background: black; color: white;">
  <h1 style="color: gold;">🔐 SafetyNet Chat Room</h1>
  <p id="room-name"></p>
  <div id="chat-box" style="border: 1px solid #555; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px;"></div>
  <input type="text" id="messageInput" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>

  <script>
    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAGWNcIpdhiQcgA3qFptlm_UR7iPpMVAss",
      authDomain: "safetynet-cf6ab.firebaseapp.com",
      projectId: "safetynet-cf6ab",
      storageBucket: "safetynet-cf6ab.firebasestorage.app",
      messagingSenderId: "599329225472",
      appId: "1:599329225472:web:15962bcf527a8a896091e5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const roomId = new URLSearchParams(window.location.search).get('room');
    const roomRef = db.ref('rooms/' + roomId);
    document.getElementById('room-name').innerText = `Room: ${roomId}`;

    let localConnection;
    let dataChannel;
    let isCaller = false;

    async function setupConnection() {
      localConnection = new RTCPeerConnection();

      // DataChannel creation
      dataChannel = localConnection.createDataChannel("chat");
      dataChannel.onmessage = (event) => receiveMessage(event.data);

      localConnection.onicecandidate = (event) => {
        if (event.candidate) {
          roomRef.child('candidates').push(JSON.stringify(event.candidate));
        }
      };

      // Handle incoming connection if not caller
      roomRef.once('value', async snapshot => {
        if (snapshot.exists()) {
          // Answerer
          isCaller = false;
          localConnection.ondatachannel = (event) => {
            dataChannel = event.channel;
            dataChannel.onmessage = (e) => receiveMessage(e.data);
          };

          const offer = JSON.parse(snapshot.val().offer);
          await localConnection.setRemoteDescription(offer);

          const answer = await localConnection.createAnswer();
          await localConnection.setLocalDescription(answer);
          roomRef.child('answer').set(JSON.stringify(answer));
        } else {
          // Caller
          isCaller = true;
          const offer = await localConnection.createOffer();
          await localConnection.setLocalDescription(offer);
          roomRef.child('offer').set(JSON.stringify(offer));
        }
      });

      // Listen for answer
      roomRef.child('answer').on('value', async snapshot => {
        if (snapshot.exists() && isCaller) {
          const answer = JSON.parse(snapshot.val());
          await localConnection.setRemoteDescription(answer);
        }
      });

      // Listen for ICE candidates
      roomRef.child('candidates').on('child_added', async snapshot => {
        const candidate = new RTCIceCandidate(JSON.parse(snapshot.val()));
        await localConnection.addIceCandidate(candidate);
      });
    }

    // UI: Send message
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (message && dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(message);
        displayMessage("You", message);
        input.value = "";
      }
    }

    // Display received message
    function receiveMessage(msg) {
      displayMessage("Stranger", msg);
    }

    // Display helper
    function displayMessage(sender, msg) {
      const chatBox = document.getElementById('chat-box');
      const p = document.createElement('p');
      p.style.color = "white";
      p.innerHTML = `<strong>${sender}:</strong> ${msg}`;
      chatBox.appendChild(p);

      setTimeout(() => {
        p.remove();
      }, 10000); // burn after 10 sec
    }

    // Start connection
    setupConnection();
  </script>
</body>
</html>
